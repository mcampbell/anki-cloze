#!/usr/bin/env ruby
# frozen_string_literal: true

require 'slop'
require 'set'

# Represents a generator for Anki cloze deletions.
class AnkiClozeGenerator
  def initialize(words, min_chunk_size: 1, split_mode: false)
    if split_mode
      @words = words.join.chars
      @separator = ''
    else
      @words = words.flat_map { |a| a.to_s.strip.split(/\s+/) }.reject(&:empty?)
      @separator = ' '
    end
    @min_chunk_size = min_chunk_size
  end

  def generate
    return if @words.empty?

    max_chunk_size = (@words.size / 2.0).ceil
    max_chunk_size = 1 if max_chunk_size < 1

    (1..max_chunk_size).each do |chunk_size|
      lines = emit_clozes_for_chunk_size(chunk_size)
      lines.each { |line| puts line } unless lines.nil?
    end
  end

  private

  def cloze(clause, n)
    return '' if n.nil? || clause.nil? || !n.positive?
    "{{c#{n}::#{clause}}}"
  end

  def emit_clozes_for_chunk_size(chunks)
    return if chunks < @min_chunk_size

    (1..chunks).map do |pass|
      acc = []
      offset = pass - 1

      if offset > 0
        prefix_items = @words[0...offset]
        prefix = prefix_items.flatten.join(@separator)
        acc << if prefix_items.size < chunks
                 prefix
               else
                 cloze(prefix, 1)
               end
      end

      remainder = @words[offset..] || []
      slices = remainder.each_slice(chunks).map.with_index do |slice, idx|
        if slice.length < chunks
          slice.join(@separator)
        else
          cloze(slice.join(@separator), idx + 1)
        end
      end

      acc.concat(slices).join(@separator)
    end
  end
end

if __FILE__ == $0
  begin
    opts = Slop.parse(ARGV) do |o|
      o.banner = 'Usage: anki-cloze [--chunks N] text...'
      o.integer '-m', '--minimum-chunk-size', 'The minimum chunk size to emit (default: 1)', default: 1
      o.bool '-s', '--split', 'Split mode: split the 1 input word by character', default: false
      o.on '-h', '--help', 'print help' do
        puts o
        exit
      end
    end

    if opts[:split] && opts.arguments.size > 1
      warn 'Error: Split mode (-s) accepts only one argument (the word to split).'
      puts opts
      exit 1
    end

    generator = AnkiClozeGenerator.new(opts.arguments, min_chunk_size: opts[:minimum_chunk_size], split_mode: opts[:split])
    generator.generate
  rescue Slop::Error => e
    warn e.message
    exit 2
  end
end
